{
    "collab_server" : "",
    "contents" : "---\ntitle: SlowWaveanalyses\nauthor: Curt, 2/3/2017; Hannah, 3/31/2017\noutput:\n  html_document:\n    highlight: pygments\n    theme: cerulean\n  pdf_document: default\n---\n\n```{r setup, include=FALSE}\nknitr::opts_chunk$set(echo = TRUE)\noptions(width=140)\nrequire(dplyr)\nrequire(lme4)\nrequire(lmerTest)\nrequire(ggplot2)\n```\n\n\n**Major changes: Reknitted with new data (trials fixed for subs 2, 4, 8, 16, 17, 19, 30, 59, 70, 72. Also, 74 and 19 were missing before, are now included.**\n\nI reprocessed the data using an automatic artifact rejection process with +- 75 uV as the threshold for rejection. SlowWave was quantified between [put in time interval here]. I selected the trials that fit these criteria:\n\n“Current” trial will be included if:  \n1) Current trial is not rejected due to artifacts.  \n2) Current trial is not the first trial of the block (i.e. trial 1, 101, 201, 301 etc. are not included).  \n3) Both current trial and previous trial are correct.  \n\nThe following electrodes are included: F3, Fz, F4, FC3, FCz, FC4, C3, Cz, C4.\n\nThe following subjects were excluded:  \n- 92 (wrong number of trials, possibly data collection error)  \n- 64 (<50% accuracy rate)  \n- 65 (only 187 usable trials (23.3%))\n\nOne or more electrodes were bad for subjects 19, 74, and 137 (data from those electrodes is discarded).  \n\nBesides that, ERP data is completely missing for subs 36, 37, 39, 40, 42, 43, 46, 51, 53, 54, 56, 57, 78.\n  \n**Total sample is 36 subjects.**  \n\n### 1. Grand averages, not looking at change over experiment\n\n``` {r plotGrand, echo=FALSE, warning=F}\nSlowWave.correct = read.delim(\"AllSubs_TBTaverages_SlowWave_Correct_withPrevious_EventFixed.txt\")\n\ntapply(SlowWave.correct$MeanCurr, SlowWave.correct$Condition, mean, na.rm=T)\n\n# estimate model (dummy code) to find marginal means-- doesn't include trial\nplot1 = lmer(MeanCurr ~ Condition*prevCond + (Condition+prevCond|Subject), data = SlowWave.correct)\n\nparms <- fixef(plot1) # fixed parameters from model\nvcmat <- vcov(plot1) # variance/covariance matrix of fixed effects\n\n## each row of this matrix defines entries of parms that we want to combine:\nTmat <- matrix(NA,4,4)\nTmat[1,] <- c(1,0,0,0) # weights for estimates for current = 0, previous = 0 (current compat-previous compat)\nTmat[2,] <- c(1,0,1,0) # weights for estimates for current = 0, previous = 1 (current compat-previous incompat)\nTmat[3,] <- c(1,1,0,0) # weights for estimates for current = 1, previous = 0 (current incompat-previous compat)\nTmat[4,] <- c(1,1,0,0) # weights for estimates for current = 1, previous = 1 (current incompat-previous incompat)\n\nparest <- Tmat %*% parms          # see above for notation\nnewvc <- Tmat %*% vcmat %*% t(Tmat)\nses <- sqrt(diag(newvc)) \n\n## calculate estimates, standard error\nfin = cbind(parest, ses) %>% as.data.frame()\nnames(fin) = c(\"est\", \"ses\")\n\n# to calculate 95% CI intervals, lower bound = m - 2*SE, upper bound = m + 2*SE\nfin$lbnd = fin$est - 2*fin$ses\nfin$ubnd = fin$est + 2*fin$ses\n\n# format for understanding\nfin$Current = c(\"Compat\", \"Compat\", \"Incompat\", \"Incompat\")\nfin$Previous = c(\"Compat\", \"Incompat\", \"Compat\", \"Incompat\")\nfin$Previous = factor(fin$Previous)\nfin$Current = factor(fin$Current)\nfin = rename(fin, Estimate = est, SE = ses) \n\n# for plot\nlimits <- aes(ymax = Estimate + SE, ymin=Estimate - SE)\nggplot(fin, aes(x = Previous, y = Estimate, group = Current, color = Current)) +\n  geom_line() +\n  geom_point(size = 4) +\n  geom_errorbar(limits, width=0.2) +\n  scale_color_manual(values=c(1, 2), guide = guide_legend(title = \"Current trial\")) +\n  ylab(\"Mean Amplitude (uV)\") +\n  xlab(\"Previous Trial\") +\n  ggtitle(\"FSW\")+\n  coord_cartesian(ylim = c(-3, -1)) +\n  theme_bw() +\n  theme(plot.title = element_text(hjust = 0.5, size = 20),\n        axis.title = element_text(size=20),\n        axis.text.x = element_text(size=16),\n        axis.text.y = element_text(size=16))\n\nggsave(\"./Figures/Figure4c.tiff\", width= 6, height= 7)\n```\n  \n*Current and Previous are effect coded.* Uses trial-level data to test (rather than individual averages). Doesn't include Trial in model. \n\n``` {r test, echo=FALSE}\n# to run model\n\n# add effect codes for categorical variables\nSlowWave.correct$Previous = NA\nSlowWave.correct$Previous[SlowWave.correct$prevCond == \"compat\"] = -1\nSlowWave.correct$Previous[SlowWave.correct$prevCond == \"incompat\"] = 1\n\nSlowWave.correct$Current = NA\nSlowWave.correct$Current[SlowWave.correct$Condition == \"Comp\"] = -1\nSlowWave.correct$Current[SlowWave.correct$Condition == \"InComp\"] = 1\n\ngrand1 = lmer(MeanCurr ~ Current*Previous + \n       (Current*Previous|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\n\n```\n  \n**Random effects:**  \n``` {r grand1random, echo = FALSE}\nsummary(grand1)$varcor\n```\n\n**Fixed effects:**\n``` {r grand1fixed, echo = FALSE} \nround(summary(grand1)$coefficients, digits = 3)\n```\n\n### 2. Looking at change over course of task  \n**This includes all data points, *not* averaged across subject or electrode.**  \n\n```{r plot, echo=FALSE, warning = FALSE}\n# calculate simple slopes\nfm2 <- lmer(MeanCurr ~ Condition*prevCond*Trial + # need to use dummy coded variables, not effect coded\n       (Condition*prevCond|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\n\nparms <- fixef(fm2) # fixed parameters from model\nvcmat <- vcov(fm2) # variance/covariance matrix of fixed effects\n\n# First calculate slopes\n\n## each row of this matrix defines entries of parms that we want to combine:\nSTmat <- matrix(NA,4,8)\nSTmat[1,] <- c(rep(0,3),1,0,0,0,0) # slope for current = 0, previous = 0 (current compat-previous compat)\nSTmat[2,] <- c(rep(0,3),1,0,0,1,0) # slope for current = 0, previous = 1 (current compat-previous incompat)\nSTmat[3,] <- c(rep(0,3),1,0,1,0,0) # slope for current = 1, previous = 0 (current incompat-previous compat)\nSTmat[4,] <- c(rep(0,3),1,0,1,1,1) # slope for current = 1, previous = 1 (current incompat-previous incompat)\n\nSparest <- STmat %*% parms          # see above for notation\nSnewvc <- STmat %*% vcmat %*% t(STmat)\nSses <- sqrt(diag(Snewvc)) \n\nslopes = cbind(Sparest, Sses) %>% as.data.frame()\nnames(slopes) = c(\"Slope\", \"Slope_SE\")\n\n# Next calculate intercepts\n\n## each row of this matrix defines entries of parms that we want to combine:\nITmat <- matrix(NA,4,8)\nITmat[1,] <- c(1,0,0,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 0 (current compat-previous compat)\nITmat[2,] <- c(1,0,1,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 1 (current compat-previous incompat)\nITmat[3,] <- c(1,1,0,0,0,rep(0,3)) # weights for estimates for current = 1, previous = 0 (current incompat-previous compat)\nITmat[4,] <- c(1,1,1,0,1,rep(0,3)) # weights for estimates for current = 1, previous = 1 (current incompat-previous incompat)\n\nIparest <- ITmat %*% parms          # see above for notation\nInewvc <- ITmat %*% vcmat %*% t(ITmat)\nIses <- sqrt(diag(Inewvc)) \n\n## final results\nintercepts = cbind(Iparest, Ises) %>% as.data.frame()\nnames(intercepts) = c(\"Intercept\", \"Intercept_SE\")\n\nforPlotting = cbind(slopes, intercepts)\n\n# label for understanding\nforPlotting$TrialCondition = c(\"Previous compatible - Current compatible\",\n                          \"Previous incompatible - Current compatible\",\n                          \"Previous compatible - Current incompatible\",\n                          \"Previous incompatible - Current incompatible\")\n\n\n# BINGO -------------------------------------------------------------------\nggplot(SlowWave.correct[!(is.na(SlowWave.correct$TrialCondition)),], aes(Trial, MeanCurr, alpha = TrialCondition, color = TrialCondition, shape = TrialCondition)) +\n  geom_point() +\n  geom_abline(data = forPlotting, aes(intercept=Intercept, slope=Slope, color = TrialCondition, linetype = TrialCondition), size=1)+\n  labs(x = \"Trial\", y = \"Amplitude (uV)\") +\n  scale_shape_manual(values=c(1,19,1,19)) +\n  scale_alpha_manual(values=c(.06,.06,.06,.06)) +\n  scale_color_manual(values=c(\"blue\", \"blue\", \"red\", \"red\")) +\n  scale_linetype_manual(values=c(\"longdash\", \"solid\", \"longdash\", \"solid\")) +\n  theme_bw() +\n  coord_cartesian(ylim=c(-5.5, 2)) +\n#  ggtitle(\"Plotted with estimates from MLM\") +\n  theme(plot.title = element_text(hjust = 0.5),\n        axis.title = element_text(size=18),\n        axis.text.x = element_text(size=14),\n        axis.text.y = element_text(size=14))\n\nggsave(\"./Figures/Figure3.tiff\")\n\n```\n  \n##### Simple slopes  \n  \nTrial is scaled to range from 0 to 8 (instead of 1 to 800) so that the betas associated with trial are a little bigger (but significance testing is unaffected by linear scaling, so the test statistics and p values will be the same as if we used the unscaled Trial variable).   \n\n``` {r simple, echo = FALSE}\n# rescale trial\nSlowWave.correct$Trial.begin = (SlowWave.correct$Trial-2)/100\n# shift trial to look at fixed effects at middle and end of task as well\nSlowWave.correct$Trial.middle = SlowWave.correct$Trial.begin - 4\nSlowWave.correct$Trial.end = SlowWave.correct$Trial.begin - 8\n\n# calculate simple slopes\nfm2 <- lmer(MeanCurr ~ Condition*prevCond*Trial.begin + # need to use dummy coded variables, not effect coded\n       (Condition*prevCond|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\n\nparms <- fixef(fm2) # fixed parameters from model\nvcmat <- vcov(fm2) # variance/covariance matrix of fixed effects\n\n## each row of this matrix defines entries of parms that we want to combine:\nTmat <- matrix(NA,4,8)\nTmat[1,] <- c(rep(0,3),1,0,0,0,0) # weights for estimates for current = 0, previous = 0 (current compat-previous compat)\nTmat[2,] <- c(rep(0,3),1,0,0,1,0) # weights for estimates for current = 0, previous = 1 (current compat-previous incompat)\nTmat[3,] <- c(rep(0,3),1,0,1,0,0) # weights for estimates for current = 1, previous = 0 (current incompat-previous compat)\nTmat[4,] <- c(rep(0,3),1,0,1,1,1) # weights for estimates for current = 1, previous = 1 (current incompat-previous incompat)\n\nparest <- Tmat %*% parms          # see above for notation\nnewvc <- Tmat %*% vcmat %*% t(Tmat)\nses <- sqrt(diag(newvc)) \n\n## final results\nfin = cbind(parest, ses) %>% as.data.frame()\nnames(fin) = c(\"est\", \"ses\")\n\n# to calculate 95% CI intervals, lower bound = m - 2*SE, upper bound = m + 2*SE\n\nfin$lbnd = fin$est - 2*fin$ses\nfin$ubnd = fin$est + 2*fin$ses\n\nfin = format(fin, digits = 3)\n\n# relabel for understanding\nfin$Current = c(\"Compat\", \"Compat\", \"Incompat\", \"Incompat\")\nfin$Previous = c(\"Compat\", \"Incompat\", \"Compat\", \"Incompat\")\nfin$Color = c(\"dark blue\", \"dark red\", \"light blue\", \"light red\")\n\nfin = rename(fin, Estimate = est, SE = ses, ci95_lower = lbnd, ci95_upper = ubnd)\n\n# display\nfin\n```  \n\n#### Beginning of experiment \nThe intercept and slopes of current and previous trial condition are allowed to vary by subject. The intercept is allowed to vary by electrode nested within subject.   \n  \nTrial is scaled to range from 0 to 8.  \n\nCategorical variables are effect coded.  \n\n``` {r model1, echo = FALSE}\n\nm1 = lmer(MeanCurr ~ Current*Previous*Trial.begin + \n       (Current*Previous|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\n```\n\n**Random effects:**  \n``` {r model1random, echo = FALSE}\nsummary(m1)$varcor\n```\n\n**Fixed effects:**\n``` {r model1fixed, echo = FALSE} \nround(summary(m1)$coefficients[c(1:3,5),1:5], digits = 3)\nround(summary(m1)$coefficients[c(4,6:8),1:5], digits = 3)\n```\n\n**Marginal means:**  \nError bars represent standard error.  \n``` {r model1marginal, echo = FALSE}\n# use dummy coded model\n# was calculated earlier for simple slopes (fm2)\nparms <- fixef(fm2) # fixed parameters from model\nvcmat <- vcov(fm2) # variance/covariance matrix of fixed effects\n\n## each row of this matrix defines entries of parms that we want to combine:\nTmat <- matrix(NA,4,8)\nTmat[1,] <- c(1,0,0,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 0 (current compat-previous compat)\nTmat[2,] <- c(1,0,1,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 1 (current compat-previous incompat)\nTmat[3,] <- c(1,1,0,0,0,rep(0,3)) # weights for estimates for current = 1, previous = 0 (current incompat-previous compat)\nTmat[4,] <- c(1,1,0,0,1,rep(0,3)) # weights for estimates for current = 1, previous = 1 (current incompat-previous incompat)\n\nparest <- Tmat %*% parms          # see above for notation\nnewvc <- Tmat %*% vcmat %*% t(Tmat)\nses <- sqrt(diag(newvc)) \n\n## calculate estimates, standard error\nfin = cbind(parest, ses) %>% as.data.frame()\nnames(fin) = c(\"est\", \"ses\")\n\n# to calculate 95% CI intervals, lower bound = m - 2*SE, upper bound = m + 2*SE\nfin$lbnd = fin$est - 2*fin$ses\nfin$ubnd = fin$est + 2*fin$ses\n\n# format for understanding\nfin$Current = c(\"Compat\", \"Compat\", \"Incompat\", \"Incompat\")\nfin$Previous = c(\"Compat\", \"Incompat\", \"Compat\", \"Incompat\")\nfin$Previous = factor(fin$Previous)\nfin$Current = factor(fin$Current)\nfin = rename(fin, Estimate = est, SE = ses) \n\n# for plotting\nlimits <- aes(ymax = Estimate + SE, ymin=Estimate - SE)\nggplot(fin, aes(x = Previous, y = Estimate, group = Current, color = Current)) +\n  geom_line() +\n  geom_point(size = 4) +\n  geom_errorbar(limits, width=0.2) +\n  scale_color_manual(values=c(\"purple\", \"forestgreen\")) +\n  ylab(\"Slowwave amplitude\") +\n  coord_cartesian(ylim = c(-4.2, -.2))\n  \n```\n\n\n#### Middle of experiment \nTrial is shifted so that trial ranges from -4 to 4.  \n*Just the fixed effects of Current and Previous are shown, the random effects and fixed effects of any Trial interactions will be the same as the first model.*  \n\n**Fixed effects:**\n``` {r model2, echo = FALSE}\n# effect\nm2 = lmer(MeanCurr ~ Current*Previous*Trial.middle + \n       (Current*Previous|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\n\nround(summary(m2)$coefficients[c(1:3,5),1:5], digits = 3)\n\n```\n**Marginal means:**  \nError bars represent standard error.  \n``` {r model2marginal, echo = FALSE}\n# use dummy coded model\nfm3 <- lmer(MeanCurr ~ Condition*prevCond*Trial.middle + # need to use dummy coded variables, not effect coded\n       (Condition*prevCond|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\nparms <- fixef(fm3) # fixed parameters from model\nvcmat <- vcov(fm3) # variance/covariance matrix of fixed effects\n\n## each row of this matrix defines entries of parms that we want to combine:\nTmat <- matrix(NA,4,8)\nTmat[1,] <- c(1,0,0,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 0 (current compat-previous compat)\nTmat[2,] <- c(1,0,1,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 1 (current compat-previous incompat)\nTmat[3,] <- c(1,1,0,0,0,rep(0,3)) # weights for estimates for current = 1, previous = 0 (current incompat-previous compat)\nTmat[4,] <- c(1,1,0,0,1,rep(0,3)) # weights for estimates for current = 1, previous = 1 (current incompat-previous incompat)\n\nparest <- Tmat %*% parms          # see above for notation\nnewvc <- Tmat %*% vcmat %*% t(Tmat)\nses <- sqrt(diag(newvc)) \n\n## calculate estimates, standard error\nfin = cbind(parest, ses) %>% as.data.frame()\nnames(fin) = c(\"est\", \"ses\")\n\n# to calculate 95% CI intervals, lower bound = m - 2*SE, upper bound = m + 2*SE\nfin$lbnd = fin$est - 2*fin$ses\nfin$ubnd = fin$est + 2*fin$ses\n\n# format for understanding\nfin$Current = c(\"Compat\", \"Compat\", \"Incompat\", \"Incompat\")\nfin$Previous = c(\"Compat\", \"Incompat\", \"Compat\", \"Incompat\")\nfin$Previous = factor(fin$Previous)\nfin$Current = factor(fin$Current)\nfin = rename(fin, Estimate = est, SE = ses) \n\n# for plot\nlimits <- aes(ymax = Estimate + SE, ymin=Estimate - SE)\nggplot(fin, aes(x = Previous, y = Estimate, group = Current, color = Current)) +\n  geom_line() +\n  geom_point(size = 4) +\n  geom_errorbar(limits, width=0.2) +\n  scale_color_manual(values=c(\"purple\", \"forestgreen\")) +\n  ylab(\"Slowwave amplitude\") +\n  coord_cartesian(ylim = c(-4.2, -.2))\n```\n\n\n#### End of experiment \nTrial is shifted so that trial ranges from -8 to 0.  \n*Just the fixed effects of Current and Previous are shown, the random effects and fixed effects of any Trial interactions will be the same as the first model.*\n  \n**Fixed effects:**\n``` {r model3, echo = FALSE}\nm3 = lmer(MeanCurr ~ Current*Previous*Trial.end + \n       (Current*Previous|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\n\nround(summary(m3)$coefficients[c(1:3,5),1:5], digits = 3)\n\n```\n\n**Marginal means:**  \nError bars represent standard error.  \n``` {r model3marginal, echo = FALSE}\n# use dummy coded model\nfm4 <- lmer(MeanCurr ~ Condition*prevCond*Trial.end + # need to use dummy coded variables, not effect coded\n              (Condition*prevCond|Subject) + (1|Electrode:Subject), data = SlowWave.correct)\nparms <- fixef(fm4) # fixed parameters from model\nvcmat <- vcov(fm4) # variance/covariance matrix of fixed effects\n\n## each row of this matrix defines entries of parms that we want to combine:\nTmat <- matrix(NA,4,8)\nTmat[1,] <- c(1,0,0,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 0 (current compat-previous compat)\nTmat[2,] <- c(1,0,1,0,0,rep(0,3)) # weights for estimates for current = 0, previous = 1 (current compat-previous incompat)\nTmat[3,] <- c(1,1,0,0,0,rep(0,3)) # weights for estimates for current = 1, previous = 0 (current incompat-previous compat)\nTmat[4,] <- c(1,1,0,0,1,rep(0,3)) # weights for estimates for current = 1, previous = 1 (current incompat-previous incompat)\n\nparest <- Tmat %*% parms          # see above for notation\nnewvc <- Tmat %*% vcmat %*% t(Tmat)\nses <- sqrt(diag(newvc)) \n\n## calculate estimates, standard error\nfin = cbind(parest, ses) %>% as.data.frame()\nnames(fin) = c(\"est\", \"ses\")\n\n# to calculate 95% CI intervals, lower bound = m - 2*SE, upper bound = m + 2*SE\nfin$lbnd = fin$est - 2*fin$ses\nfin$ubnd = fin$est + 2*fin$ses\n\n# format for understanding\nfin$Current = c(\"Compat\", \"Compat\", \"Incompat\", \"Incompat\")\nfin$Previous = c(\"Compat\", \"Incompat\", \"Compat\", \"Incompat\")\nfin$Previous = factor(fin$Previous)\nfin$Current = factor(fin$Current)\nfin = rename(fin, Estimate = est, SE = ses) \n\n# for plotting\nlimits <- aes(ymax = Estimate + SE, ymin=Estimate - SE)\nggplot(fin, aes(x = Previous, y = Estimate, group = Current, color = Current)) +\n  geom_line() +\n  geom_point(size = 4) +\n  geom_errorbar(limits, width=0.2) +\n  scale_color_manual(values=c(\"purple\", \"forestgreen\")) +\n  ylab(\"Slowwave amplitude\") +\n  coord_cartesian(ylim = c(-4.2, -.2))\n```\n\n",
    "created" : 1491250767696.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "2880664941",
    "id" : "FBDDC23E",
    "lastKnownWriteTime" : 1490989330,
    "last_content_update" : 1490989330,
    "path" : "~/Documents/Projects/8 Conflict adaptation- AlcCaf/Analyses/C_SlowWave_Analyses.Rmd",
    "project_path" : "C_SlowWave_Analyses.Rmd",
    "properties" : {
        "chunk_output_type" : "console",
        "last_setup_crc32" : ""
    },
    "relative_order" : 4,
    "source_on_save" : false,
    "source_window" : "",
    "type" : "r_markdown"
}